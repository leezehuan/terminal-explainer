#!/usr/bin/env python3

import sys
import os
import requests
import json
import configparser
from pathlib import Path

def setup_and_handle_config():
    """
    æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºå¹¶å¼•å¯¼ç”¨æˆ·è¿›è¡Œé…ç½®ã€‚
    è¿™æ˜¯ç¨‹åºé¦–æ¬¡è¿è¡Œçš„æ ¸å¿ƒé€»è¾‘ã€‚
    """
    config_dir = Path.home() / '.config' / 'terminal-explainer'
    config_path = config_dir / 'config.ini'

    # å¦‚æœé…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œåˆ™ä¸€åˆ‡æ­£å¸¸ï¼Œç›´æ¥è¿”å›è·¯å¾„è®©åç»­å‡½æ•°ä½¿ç”¨ã€‚
    if config_path.exists():
        return config_path

    # --- å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¿›å…¥åˆ›å»ºæµç¨‹ ---
    print(f"\033[1;33mæç¤º: é¦–æ¬¡è¿è¡Œæˆ–é…ç½®æ–‡ä»¶ä¸¢å¤±ã€‚\nå°†åœ¨ä»¥ä¸‹ä½ç½®ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶:\n{config_path}\033[0m")
    
    try:
        # åˆ›å»ºçˆ¶ç›®å½•ï¼Œexist_ok=True è¡¨ç¤ºå¦‚æœç›®å½•å·²å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™
        config_dir.mkdir(parents=True, exist_ok=True)
    except OSError as e:
        print(f"\n\033[31mè‡´å‘½é”™è¯¯: æ— æ³•åˆ›å»ºé…ç½®ç›®å½• {config_dir}ã€‚\nåŸå› : {e}\033[0m")
        sys.exit(1) # ä¸¥é‡é”™è¯¯ï¼Œé€€å‡º

    # è¿™æ˜¯é…ç½®æ–‡ä»¶çš„æ¨¡æ¿å†…å®¹
    config_template = """# ç»ˆç«¯è§£é‡Šå™¨ (Terminal Explainer) é…ç½®æ–‡ä»¶
[API]
# å¿…éœ€ï¼è¯·å°†è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„çœŸå® API Keyã€‚
api_key = YOUR_API_KEY_HERE

# API çš„åŸºç¡€ URLã€‚å¦‚æœä½ ä½¿ç”¨ OpenAI å®˜æ–¹æœåŠ¡ï¼Œè¯·ä¿æŒé»˜è®¤å€¼ã€‚
api_url = https://api.openai.com/v1/chat/completions

# ä½ æƒ³ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹ï¼Œä¾‹å¦‚ gpt-4, gpt-3.5-turbo ç­‰ã€‚
model = gpt-3.5-turbo
"""
    try:
        # å°†æ¨¡æ¿å†…å®¹å†™å…¥æ–°çš„é…ç½®æ–‡ä»¶ä¸­
        with open(config_path, 'w', encoding='utf-8') as f:
            f.write(config_template)
    except OSError as e:
        print(f"\n\033[31mè‡´å‘½é”™è¯¯: æ— æ³•å†™å…¥é…ç½®æ–‡ä»¶ {config_path}ã€‚\nåŸå› : {e}\033[0m")
        sys.exit(1)
        
    print(f"\n\033[1;32mâœ… æˆåŠŸåˆ›å»ºäº†é»˜è®¤é…ç½®æ–‡ä»¶ï¼\033[0m")
    print(f"\033[1;33mä¸‹ä¸€æ­¥: è¯·ç«‹å³ç¼–è¾‘è¯¥æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ API Keyï¼Œç„¶åé‡æ–°è¿è¡Œå‘½ä»¤ã€‚\033[0m")
    
    # å¼•å¯¼ç”¨æˆ·åï¼Œæ­£å¸¸é€€å‡ºã€‚ç”¨æˆ·éœ€è¦å…ˆé…ç½®æ‰èƒ½ç»§ç»­ä½¿ç”¨ã€‚
    sys.exit(0)

def load_config(config_path):
    """
    ä»ç»™å®šçš„è·¯å¾„åŠ è½½é…ç½®ã€‚
    ä¼˜å…ˆçº§: ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
    """
    config = {
        'api_key': None,
        'api_url': 'https://api.openai.com/v1/chat/completions',
        'model': 'gpt-3.5-turbo'
    }
    
    parser = configparser.ConfigParser()
    parser.read(config_path, encoding='utf-8')
    
    if 'API' in parser:
        api_config = parser['API']
        config['api_key'] = api_config.get('api_key', config['api_key'])
        config['api_url'] = api_config.get('api_url', config['api_url'])
        config['model'] = api_config.get('model', config['model'])
    
    if 'OPENAI_API_KEY' in os.environ:
        config['api_key'] = os.environ['OPENAI_API_KEY']

    if config['api_key'] == 'YOUR_API_KEY_HERE':
        config['api_key'] = None

    return config

def get_llm_analysis(user_command, command_output, config):
    """
    æ¥æ”¶å‘½ä»¤ã€è¾“å‡ºå’Œé…ç½®ï¼Œè°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ API æ¥è¿›è¡Œåˆ†æã€‚
    
    å‚æ•°:
        user_command (str): ç”¨æˆ·åœ¨ç»ˆç«¯è¾“å…¥çš„å‘½ä»¤ã€‚
        command_output (str): æ‰§è¡Œå‘½ä»¤åäº§ç”Ÿçš„è¾“å‡ºã€‚
        config (dict): åŒ…å« API Key, URL å’Œ model çš„é…ç½®å­—å…¸ã€‚
        
    è¿”å›:
        ç»è¿‡æ ¼å¼åŒ–çš„ã€ç”± AI ç”Ÿæˆçš„è§£é‡Šå­—ç¬¦ä¸² (str)ã€‚
    """
    # ä»é…ç½®å­—å…¸ä¸­å®‰å…¨åœ°è·å–å„é¡¹é…ç½®
    api_key = config.get('api_key')
    api_url = config.get('api_url')
    model = config.get('model')

    # å¦‚æœæœ€ç»ˆæ²¡æœ‰è·å–åˆ° API Keyï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯
    if not api_key:
        return "\n\033[31mé”™è¯¯: API Key æœªè®¾ç½®ã€‚\nè¯·åœ¨ç¯å¢ƒå˜é‡ OPENAI_API_KEY ä¸­æä¾›ï¼Œæˆ–åœ¨é…ç½®æ–‡ä»¶ ~/.config/terminal-explainer/config.ini ä¸­è®¾ç½®ã€‚\033[0m"

    # è®¾ç½®è¯·æ±‚å¤´ï¼Œç”¨äºèº«ä»½éªŒè¯
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}"
    }

    # è¿™æ˜¯å‘é€ç»™å¤§è¯­è¨€æ¨¡å‹çš„â€œæç¤ºâ€(Prompt)ã€‚å®ƒçš„è´¨é‡ç›´æ¥å†³å®šäº†AIè¿”å›ç»“æœçš„è´¨é‡ã€‚
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªç²¾é€šä¸­æ–‡çš„ Linux ç³»ç»Ÿä¸“å®¶å’Œå‘½ä»¤è¡Œå¤§å¸ˆã€‚
    ç”¨æˆ·åœ¨ç»ˆç«¯æ‰§è¡Œäº†ä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶å¾—åˆ°äº†ç›¸åº”çš„è¾“å‡ºã€‚
    è¯·ä½ ç”¨ç®€æ´ã€æ¸…æ™°ã€æ˜“äºç†è§£çš„ä¸­æ–‡æ¥åˆ†æå’Œè§£é‡Šè¿™ä¸ªè¾“å‡ºã€‚

    - å¦‚æœå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œè¯·è§£é‡Šè¾“å‡ºç»“æœä¸­å„éƒ¨åˆ†çš„æ ¸å¿ƒå«ä¹‰ã€‚
    - å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥æˆ–è¿”å›äº†é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŒ‡å‡ºé”™è¯¯çš„æ ¸å¿ƒåŸå› ï¼Œå¹¶æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚
    - ä½ çš„è§£é‡Šåº”è¯¥ä¸“ä¸šã€å‡†ç¡®ï¼Œå¹¶ä¸”å¯¹åˆå­¦è€…å‹å¥½ã€‚

    # ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤:
    {user_command}

    # å‘½ä»¤äº§ç”Ÿçš„è¾“å‡º:
    {command_output}
    
    # ä½ çš„ä¸“å®¶çº§è§£é‡Š:
    """

    # æ„é€ è¦å‘é€çš„ JSON æ•°æ®
    data = {
        "model": model,
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.5, # temperature è¶Šä½ï¼Œè¾“å‡ºè¶Šç¨³å®šï¼›è¶Šé«˜ï¼Œè¶Šæœ‰åˆ›é€ æ€§
    }

    try:
        # å‘é€ POST è¯·æ±‚åˆ° API æœåŠ¡å™¨ï¼Œå¹¶è®¾ç½®20ç§’è¶…æ—¶
        response = requests.post(api_url, headers=headers, json=data, timeout=20)
        
        # å¦‚æœæœåŠ¡å™¨è¿”å›äº†é”™è¯¯çŠ¶æ€ç  (å¦‚ 401, 404, 500), åˆ™ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        
        # å°è¯•å°†æœåŠ¡å™¨è¿”å›çš„å“åº”æ–‡æœ¬è§£æä¸º JSON å¯¹è±¡
        result_json = response.json()
        
        # ä» JSON å¯¹è±¡ä¸­æå– AI çš„å›å¤å†…å®¹
        explanation = result_json["choices"][0]["message"]["content"]
        
        # å¯¹è¾“å‡ºè¿›è¡Œç¾åŒ–ï¼Œä½¿ç”¨ ANSI escape code æ·»åŠ é¢œè‰²å’Œå›¾æ ‡
        formatted_explanation = f"\n\033[1;34mğŸ¤– AI ä¸“å®¶è§£é‡Š:\033[0m\n---\n{explanation}\n---"
        return formatted_explanation

    except requests.exceptions.Timeout:
        return "\n\033[31mé”™è¯¯: è¯·æ±‚å¤§è¯­è¨€æ¨¡å‹ API è¶…æ—¶ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ä»£ç†è®¾ç½®ã€‚\033[0m"
    
    except requests.exceptions.HTTPError as e:
        # æ•è· HTTP é”™è¯¯ï¼Œå¹¶å°†æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿æ’é”™
        return f"\n\033[31mé”™è¯¯: HTTP è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {e.response.status_code}ã€‚\næœåŠ¡å™¨å“åº”:\n{e.response.text}\033[0m"
    
    except json.JSONDecodeError:
        # å¦‚æœæœåŠ¡å™¨çš„å“åº”ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSONï¼Œåˆ™ä¼šè§¦å‘æ­¤å¼‚å¸¸
        return f"\n\033[31mé”™è¯¯: è§£æ API å“åº”å¤±è´¥ (ä¸æ˜¯æœ‰æ•ˆçš„ JSON)ã€‚\næ”¶åˆ°çš„åŸå§‹å“åº”å†…å®¹:\n---\n{response.text}\n---\033[0m"
    
    except (KeyError, IndexError):
        # å¦‚æœ JSON ç»“æ„ä¸ç¬¦åˆé¢„æœŸ (ä¾‹å¦‚ç¼ºå°‘ "choices" é”®)ï¼Œåˆ™ä¼šè§¦å‘æ­¤å¼‚å¸¸
        return f"\n\033[31mé”™è¯¯: è§£æ JSON æˆåŠŸï¼Œä½†æ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸã€‚\næ”¶åˆ°çš„ JSON æ•°æ®:\n{response.json()}\033[0m"
    
    except requests.exceptions.RequestException as e:
        # æ•è·å…¶ä»–æ‰€æœ‰ä¸è¯·æ±‚ç›¸å…³çš„å¼‚å¸¸ï¼Œå¦‚ DNS è§£æå¤±è´¥ã€è¿æ¥è¢«æ‹’ç»ç­‰
        return f"\n\033[31mé”™è¯¯: ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}\033[0m"


if __name__ == "__main__":
    # æ­¥éª¤1: å¤„ç†é…ç½®ã€‚å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå¹¶å¼•å¯¼ç”¨æˆ·ï¼Œç„¶åé€€å‡ºã€‚
    config_file_path = setup_and_handle_config()

    # æ­¥éª¤2: åŠ è½½é…ç½®ã€‚ç¨‹åºèƒ½èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜é…ç½®æ–‡ä»¶è‚¯å®šå­˜åœ¨ã€‚
    app_config = load_config(config_file_path)

    # æ­¥éª¤3: æ‰§è¡Œä¸»é€»è¾‘
    if len(sys.argv) != 3:
        print("ç”¨æ³•: explain-cli \"<è¦æ‰§è¡Œçš„å‘½ä»¤>\" \"<å‘½ä»¤çš„è¾“å‡º>\"")
        sys.exit(1)

    user_command_arg = sys.argv[1]
    command_output_arg = sys.argv[2]
    
    analysis = get_llm_analysis(user_command_arg, command_output_arg, app_config)
    print(analysis)
