#!/usr/bin/env python3

import sys
import os
import requests
import json
import configparser  # ç”¨äºè§£æ .ini é…ç½®æ–‡ä»¶
from pathlib import Path # ç”¨äºä¼˜é›…åœ°å¤„ç†æ–‡ä»¶è·¯å¾„

def load_config():
    """
    åŠ è½½é…ç½®ä¿¡æ¯ã€‚
    éµå¾ªçš„ä¼˜å…ˆçº§é¡ºåºä¸º: ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > ä»£ç ä¸­çš„é»˜è®¤å€¼ã€‚
    è¿™æä¾›äº†æœ€å¤§çš„çµæ´»æ€§ã€‚
    
    è¿”å›:
        ä¸€ä¸ªåŒ…å«é…ç½®ä¿¡æ¯çš„å­—å…¸ (dict)ã€‚
    """
    # 1. è®¾ç½®é»˜è®¤é…ç½®
    config = {
        'api_key': None,
        'api_url': 'https://api.openai.com/v1/chat/completions',
        'model': 'gpt-3.5-turbo'
    }

    # 2. ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®ï¼Œå¹¶è¦†ç›–é»˜è®¤å€¼
    # ä½¿ç”¨ Path.home() æ¥è·å–å½“å‰ç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œæ„é€ é…ç½®æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
    config_path = Path.home() / '.config' / 'terminal-explainer' / 'config.ini'
    
    if config_path.exists():
        parser = configparser.ConfigParser()
        parser.read(config_path, encoding='utf-8') # ä½¿ç”¨ utf-8 ç¼–ç è¯»å–
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨ [API] åŒºå—
        if 'API' in parser:
            api_config = parser['API']
            # ä½¿ç”¨ .get() æ–¹æ³•ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é»˜è®¤å€¼ï¼Œé¿å…å‡ºé”™
            config['api_key'] = api_config.get('api_key', config['api_key'])
            config['api_url'] = api_config.get('api_url', config['api_url'])
            config['model'] = api_config.get('model', config['model'])
    
    # 3. ç¯å¢ƒå˜é‡å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¼šè¦†ç›–ä¹‹å‰æ‰€æœ‰çš„è®¾ç½®
    if 'OPENAI_API_KEY' in os.environ:
        config['api_key'] = os.environ['OPENAI_API_KEY']

    # 4. æ¸…ç†å¯èƒ½å­˜åœ¨çš„å ä½ç¬¦
    # é˜²æ­¢ç”¨æˆ·å¿˜è®°ä¿®æ”¹æ¨¡æ¿ä¸­çš„ 'YOUR_API_KEY_HERE'
    if config['api_key'] == 'YOUR_API_KEY_HERE':
        config['api_key'] = None

    return config

def get_llm_analysis(user_command, command_output, config):
    """
    æ¥æ”¶å‘½ä»¤ã€è¾“å‡ºå’Œé…ç½®ï¼Œè°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ API æ¥è¿›è¡Œåˆ†æã€‚
    
    å‚æ•°:
        user_command (str): ç”¨æˆ·åœ¨ç»ˆç«¯è¾“å…¥çš„å‘½ä»¤ã€‚
        command_output (str): æ‰§è¡Œå‘½ä»¤åäº§ç”Ÿçš„è¾“å‡ºã€‚
        config (dict): åŒ…å« API Key, URL å’Œ model çš„é…ç½®å­—å…¸ã€‚
        
    è¿”å›:
        ç»è¿‡æ ¼å¼åŒ–çš„ã€ç”± AI ç”Ÿæˆçš„è§£é‡Šå­—ç¬¦ä¸² (str)ã€‚
    """
    # ä»é…ç½®å­—å…¸ä¸­å®‰å…¨åœ°è·å–å„é¡¹é…ç½®
    api_key = config.get('api_key')
    api_url = config.get('api_url')
    model = config.get('model')

    # å¦‚æœæœ€ç»ˆæ²¡æœ‰è·å–åˆ° API Keyï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯
    if not api_key:
        return "\n\033[31mé”™è¯¯: API Key æœªè®¾ç½®ã€‚\nè¯·åœ¨ç¯å¢ƒå˜é‡ OPENAI_API_KEY ä¸­æä¾›ï¼Œæˆ–åœ¨é…ç½®æ–‡ä»¶ ~/.config/terminal-explainer/config.ini ä¸­è®¾ç½®ã€‚\033[0m"

    # è®¾ç½®è¯·æ±‚å¤´ï¼Œç”¨äºèº«ä»½éªŒè¯
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {api_key}"
    }

    # è¿™æ˜¯å‘é€ç»™å¤§è¯­è¨€æ¨¡å‹çš„â€œæç¤ºâ€(Prompt)ã€‚å®ƒçš„è´¨é‡ç›´æ¥å†³å®šäº†AIè¿”å›ç»“æœçš„è´¨é‡ã€‚
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªç²¾é€šä¸­æ–‡çš„ Linux ç³»ç»Ÿä¸“å®¶å’Œå‘½ä»¤è¡Œå¤§å¸ˆã€‚
    ç”¨æˆ·åœ¨ç»ˆç«¯æ‰§è¡Œäº†ä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶å¾—åˆ°äº†ç›¸åº”çš„è¾“å‡ºã€‚
    è¯·ä½ ç”¨ç®€æ´ã€æ¸…æ™°ã€æ˜“äºç†è§£çš„ä¸­æ–‡æ¥åˆ†æå’Œè§£é‡Šè¿™ä¸ªè¾“å‡ºã€‚

    - å¦‚æœå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œè¯·è§£é‡Šè¾“å‡ºç»“æœä¸­å„éƒ¨åˆ†çš„æ ¸å¿ƒå«ä¹‰ã€‚
    - å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥æˆ–è¿”å›äº†é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŒ‡å‡ºé”™è¯¯çš„æ ¸å¿ƒåŸå› ï¼Œå¹¶æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆã€‚
    - ä½ çš„è§£é‡Šåº”è¯¥ä¸“ä¸šã€å‡†ç¡®ï¼Œå¹¶ä¸”å¯¹åˆå­¦è€…å‹å¥½ã€‚

    # ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤:
    {user_command}

    # å‘½ä»¤äº§ç”Ÿçš„è¾“å‡º:
    {command_output}
    
    # ä½ çš„ä¸“å®¶çº§è§£é‡Š:
    """

    # æ„é€ è¦å‘é€çš„ JSON æ•°æ®
    data = {
        "model": model,
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.5, # temperature è¶Šä½ï¼Œè¾“å‡ºè¶Šç¨³å®šï¼›è¶Šé«˜ï¼Œè¶Šæœ‰åˆ›é€ æ€§
    }

    try:
        # å‘é€ POST è¯·æ±‚åˆ° API æœåŠ¡å™¨ï¼Œå¹¶è®¾ç½®20ç§’è¶…æ—¶
        response = requests.post(api_url, headers=headers, json=data, timeout=20)
        
        # å¦‚æœæœåŠ¡å™¨è¿”å›äº†é”™è¯¯çŠ¶æ€ç  (å¦‚ 401, 404, 500), åˆ™ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        
        # å°è¯•å°†æœåŠ¡å™¨è¿”å›çš„å“åº”æ–‡æœ¬è§£æä¸º JSON å¯¹è±¡
        result_json = response.json()
        
        # ä» JSON å¯¹è±¡ä¸­æå– AI çš„å›å¤å†…å®¹
        explanation = result_json["choices"][0]["message"]["content"]
        
        # å¯¹è¾“å‡ºè¿›è¡Œç¾åŒ–ï¼Œä½¿ç”¨ ANSI escape code æ·»åŠ é¢œè‰²å’Œå›¾æ ‡
        formatted_explanation = f"\n\033[1;34mğŸ¤– AI ä¸“å®¶è§£é‡Š:\033[0m\n---\n{explanation}\n---"
        return formatted_explanation

    except requests.exceptions.Timeout:
        return "\n\033[31mé”™è¯¯: è¯·æ±‚å¤§è¯­è¨€æ¨¡å‹ API è¶…æ—¶ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥æˆ–ä»£ç†è®¾ç½®ã€‚\033[0m"
    
    except requests.exceptions.HTTPError as e:
        # æ•è· HTTP é”™è¯¯ï¼Œå¹¶å°†æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿æ’é”™
        return f"\n\033[31mé”™è¯¯: HTTP è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {e.response.status_code}ã€‚\næœåŠ¡å™¨å“åº”:\n{e.response.text}\033[0m"
    
    except json.JSONDecodeError:
        # å¦‚æœæœåŠ¡å™¨çš„å“åº”ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSONï¼Œåˆ™ä¼šè§¦å‘æ­¤å¼‚å¸¸
        return f"\n\033[31mé”™è¯¯: è§£æ API å“åº”å¤±è´¥ (ä¸æ˜¯æœ‰æ•ˆçš„ JSON)ã€‚\næ”¶åˆ°çš„åŸå§‹å“åº”å†…å®¹:\n---\n{response.text}\n---\033[0m"
    
    except (KeyError, IndexError):
        # å¦‚æœ JSON ç»“æ„ä¸ç¬¦åˆé¢„æœŸ (ä¾‹å¦‚ç¼ºå°‘ "choices" é”®)ï¼Œåˆ™ä¼šè§¦å‘æ­¤å¼‚å¸¸
        return f"\n\033[31mé”™è¯¯: è§£æ JSON æˆåŠŸï¼Œä½†æ•°æ®ç»“æ„ä¸ç¬¦åˆé¢„æœŸã€‚\næ”¶åˆ°çš„ JSON æ•°æ®:\n{response.json()}\033[0m"
    
    except requests.exceptions.RequestException as e:
        # æ•è·å…¶ä»–æ‰€æœ‰ä¸è¯·æ±‚ç›¸å…³çš„å¼‚å¸¸ï¼Œå¦‚ DNS è§£æå¤±è´¥ã€è¿æ¥è¢«æ‹’ç»ç­‰
        return f"\n\033[31mé”™è¯¯: ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}\033[0m"


# å½“è¿™ä¸ªè„šæœ¬ä½œä¸ºä¸»ç¨‹åºç›´æ¥è¿è¡Œæ—¶ï¼Œä»¥ä¸‹ä»£ç å—å°†è¢«æ‰§è¡Œ
if __name__ == "__main__":
    # é¦–å…ˆï¼ŒåŠ è½½æ‰€æœ‰é…ç½®
    app_config = load_config()

    # æ£€æŸ¥ä»å‘½ä»¤è¡Œä¼ å…¥çš„å‚æ•°æ•°é‡æ˜¯å¦æ­£ç¡®
    # sys.argv æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«äº†æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°
    # sys.argv[0] æ˜¯è„šæœ¬å, sys.argv[1] æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°, ä»¥æ­¤ç±»æ¨
    if len(sys.argv) != 3:
        print("ç”¨æ³•: explain-cli \"<è¦æ‰§è¡Œçš„å‘½ä»¤>\" \"<å‘½ä»¤çš„è¾“å‡º>\"")
        sys.exit(1) # å¼‚å¸¸é€€å‡º

    # ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å–å‘½ä»¤å’Œè¾“å‡º
    user_command_arg = sys.argv[1]
    command_output_arg = sys.argv[2]
    
    # è°ƒç”¨æ ¸å¿ƒåˆ†æå‡½æ•°ï¼Œå¹¶ä¼ å…¥é…ç½®
    analysis = get_llm_analysis(user_command_arg, command_output_arg, app_config)
    
    # å°†æœ€ç»ˆç»“æœæ‰“å°åˆ°æ ‡å‡†è¾“å‡º
    print(analysis)
